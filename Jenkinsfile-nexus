pipeline {
    agent any

    tools {
        maven "Maven-3.8.4"
    }

    environment {
        NEXUS_URL            = "184.72.214.81:8081"
        NEXUS_REPOSITORY     = "releases"
        NEXUS_CREDENTIAL_ID  = "nexus-creds"

        SLACK_CHANNEL        = "#jenkins-integration"
        SLACK_CREDENTIAL_ID  = "slack_notification"
    }

    stages {
        stage("Clone code") {
            steps {
                git 'https://github.com/imrankhanmohammad257/spring3-mvc-maven-xml-hello-world-1.git'
            }
        }

        stage("Maven build") {
            steps {
                sh 'mvn -B -Dmaven.test.failure.ignore=true clean install'
            }
        }

        stage("Publish to Nexus") {
            steps {
                script {
                    def pom = readMavenPom file: 'pom.xml'
                    def artifactVersion = pom.version
                    def groupId = pom.groupId
                    def artifactId = pom.artifactId

                    def warFiles = findFiles(glob: "target/${artifactId}-${artifactVersion}.war")
                    if (warFiles.length == 0) {
                        error "WAR file not found: target/${artifactId}-${artifactVersion}.war"
                    }

                    def warFile = warFiles[0].path

                    echo "Uploading artifact: ${warFile} to Nexus (${NEXUS_URL})"

                    nexusArtifactUploader(
                        artifacts: [[
                            artifactId: artifactId,
                            classifier: '',
                            file: warFile,
                            type: 'war'
                        ], [
                            artifactId: artifactId,
                            classifier: '',
                            file: 'pom.xml',
                            type: 'pom'
                        ]],
                        credentialsId: NEXUS_CREDENTIAL_ID,
                        groupId: groupId,
                        version: artifactVersion,
                        repository: NEXUS_REPOSITORY,
                        nexusUrl: NEXUS_URL
                    )
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Build and Upload to Nexus Successful!"
            slackSend(
                channel: SLACK_CHANNEL,
                color: 'good',
                message: "‚úÖ Pipeline '${env.JOB_NAME} [${env.BUILD_NUMBER}]' SUCCESS ‚Äî Artifact uploaded to Nexus! <${env.BUILD_URL}|Open Build>"
            )
            cleanWs()
        }
        failure {
            echo "‚ùå Pipeline Failed!"
            slackSend(
                channel: SLACK_CHANNEL,
                color: 'danger',
                message: "‚ùå Pipeline '${env.JOB_NAME} [${env.BUILD_NUMBER}]' FAILED! <${env.BUILD_URL}|Open Build>"
            )
            cleanWs()
        }
        always {
            echo "üßπ Cleaning workspace..."
            cleanWs()
        }
    }
}
